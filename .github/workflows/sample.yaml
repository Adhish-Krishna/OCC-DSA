name: Sample Workflow

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  pull_request_target:
    types: [closed]

permissions:
  contents: read
  pull-requests: write

jobs:
  pre-merge-checks:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Log PR event
        run: |
          echo "Pull request event detected."
          echo "Action: ${{ github.event.action }}"
          echo "PR: #${{ github.event.pull_request.number }} - ${{ github.event.pull_request.title }}"

      - name: Detect suspicious patterns in changed files
        id: scan
        shell: bash
        run: |
          set -euo pipefail
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          git diff --name-only "$BASE_SHA" "$HEAD_SHA" > changed_files.txt

          suspicious='(rm -rf /|curl\s+[^|]*\|\s*(sh|bash)|wget\s+[^|]*\|\s*(sh|bash)|eval\s*\(|nc\s+-e|mkfs\.)'
          matches_file="suspicious_matches.txt"
          : > "$matches_file"

          while IFS= read -r file; do
            [ -f "$file" ] || continue
            if grep -Ein "$suspicious" "$file" >/dev/null; then
              echo "----- $file -----" >> "$matches_file"
              grep -Ein "$suspicious" "$file" >> "$matches_file"
            fi
          done < changed_files.txt

          if [ -s "$matches_file" ]; then
            echo "found=true" >> "$GITHUB_OUTPUT"
            {
              echo "details<<EOF"
              sed 's/`/\\`/g' "$matches_file"
              echo "EOF"
            } >> "$GITHUB_OUTPUT"
            exit 1
          else
            echo "found=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Comment on PR when suspicious patterns are found
        if: failure() && steps.scan.outputs.found == 'true'
        uses: actions/github-script@v7
        env:
          DETAILS: ${{ steps.scan.outputs.details }}
        with:
          script: |
            const body = [
              "Automated pre-merge safety checks failed.",
              "",
              "Suspicious patterns were detected in changed files. Please review and remove risky content before merge.",
              "",
              "```text",
              process.env.DETAILS || "No details captured.",
              "```"
            ].join("\n");
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body
            });

  post-merge:
    if: github.event_name == 'pull_request_target' && github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    steps:
      - name: Log post-merge event
        run: |
          echo "Pull request merged."
          echo "Merged PR: #${{ github.event.pull_request.number }} - ${{ github.event.pull_request.title }}"
          echo "Merged by: ${{ github.event.pull_request.merged_by.login }}"
